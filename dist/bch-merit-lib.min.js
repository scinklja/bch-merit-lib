!function(t){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).BchMessage=t()}}((function(){var t,e,n,r=t={};function o(){throw new Error("setTimeout has not been defined")}function i(){throw new Error("clearTimeout has not been defined")}function s(t){if(e===setTimeout)return setTimeout(t,0);if((e===o||!e)&&setTimeout)return e=setTimeout,setTimeout(t,0);try{return e(t,0)}catch(n){try{return e.call(null,t,0)}catch(n){return e.call(this,t,0)}}}!function(){try{e="function"==typeof setTimeout?setTimeout:o}catch(t){e=o}try{n="function"==typeof clearTimeout?clearTimeout:i}catch(t){n=i}}();var a,c=[],l=!1,h=-1;function u(){l&&a&&(l=!1,a.length?c=a.concat(c):h=-1,c.length&&f())}function f(){if(!l){var t=s(u);l=!0;for(var e=c.length;e;){for(a=c,c=[];++h<e;)a&&a[h].run();h=-1,e=c.length}a=null,l=!1,function(t){if(n===clearTimeout)return clearTimeout(t);if((n===i||!n)&&clearTimeout)return n=clearTimeout,clearTimeout(t);try{n(t)}catch(e){try{return n.call(null,t)}catch(e){return n.call(this,t)}}}(t)}}function d(t,e){this.fun=t,this.array=e}function w(){}r.nextTick=function(t){var e=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)e[n-1]=arguments[n];c.push(new d(t,e)),1!==c.length||l||s(f)},d.prototype.run=function(){this.fun.apply(null,this.array)},r.title="browser",r.browser=!0,r.env={},r.argv=[],r.version="",r.versions={},r.on=w,r.addListener=w,r.once=w,r.off=w,r.removeListener=w,r.removeAllListeners=w,r.emit=w,r.prependListener=w,r.prependOnceListener=w,r.listeners=function(t){return[]},r.binding=function(t){throw new Error("process.binding is not supported")},r.cwd=function(){return"/"},r.chdir=function(t){throw new Error("process.chdir is not supported")},r.umask=function(){return 0};var g={};(function(t){(function(){g=class{constructor(t={}){if(!t.wallet)throw new Error("Instance of minimal-slp-wallet must be passed in the config object when instantiating.");this.wallet=t.wallet,this.bchjs=t.wallet.bchjs}async getTokenUtxos(t,e,n){try{t=this.bchjs.SLP.Address.toCashAddress(t);const n=(await this.wallet.getUtxos(t)).slpUtxos.type1.tokens;let r;return r=e?n.filter(t=>t.tokenId&&t.tokenId.includes(e)):n.filter(t=>!t.tokenId)}catch(r){throw console.error("Error in merit.js/getTokenUtxos()"),r}}getTokenQuantity(t){try{let e=0;return t.map(t=>{e+=Number(t.tokenQty)}),e}catch(e){throw console.error("Error in merit.js/getTokenQuantity()"),e}}async calcMerit(e,n,r){try{if(!Array.isArray(e))throw new Error("Input hydratedUtxo must be an array");const o=this.bchjs.SLP.Address.toCashAddress(n),i=144;let s=0;1===t.env.MERIT_AGE&&(s=await this.bchjs.Blockchain.getBlockCount());const a=[];for(let n=0;n<e.length;n++){const c=e[n];let l,h=0;if(1===t.env.MERIT_AGE){let t=c.height;const e=await this.getParentAge(c.tx_hash,o);e&&(t=e.height),h=(s-t)/i,h=this.bchjs.Util.floor2(h),0===c.height&&(h=0)}l=r?Number(c.tokenQty):c.value/1e8,1===t.env.MERIT_AGE&&(l*=h),c.age=h,c.merit=l,a.push(c)}return a}catch(o){throw console.error("Error in merit.js/getMerit()"),o}}async getParentAge(t,e){try{let n=!1;for(;t;){const r=await this.findTokenParent(t,e);t=r.tx_hash,r&&(n=r)}return n}catch(n){throw console.error("Error in merit.js/getParentAge()"),n}}async findTokenParent(t,e){try{let n=!1,r=await this.wallet.getTxData([t]);const o=(r=r[0]).tokenId,i=r.vin.map(t=>({txid:t.txid,vout:t.vout})),s=await this.wallet.getTransactions(e);for(let t=0;t<i.length;t++){const e=i[t].txid,r=s.filter(t=>t.tx_hash===e);if(r.length>0)for(let s=0;s<r.length;s++){const e=r[s],a=await this.wallet.getTxData([e.tx_hash]),c=a[0].tokenId;e.tx_pos=i[t].vout,a[0].isValidSlp&&o===c&&(n=e)}}return n}catch(n){throw console.error("Error in findTokenParent()"),n}}async agMerit(t,e,n){try{if(!t)throw new Error("an address must be specified!");const r=await this.getTokenUtxos(t,e,n),o=await this.calcMerit(r,t,e);let i=0;return o.map(t=>i+=t.merit),i}catch(r){throw console.error("Error in merit.js/agMerit()"),r}}}}).call(this)}).call(this,t);return class{constructor(t={}){if(!t.wallet)throw new Error("minimal-slp-wallet instance must be passed in the config object when instantiating.");this.wallet=t.wallet,this.merit=new g(t)}}}));