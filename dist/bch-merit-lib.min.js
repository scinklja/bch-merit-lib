!function(t){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).BchMessage=t()}}((function(){var t,e,r,n=t={};function o(){throw new Error("setTimeout has not been defined")}function i(){throw new Error("clearTimeout has not been defined")}function s(t){if(e===setTimeout)return setTimeout(t,0);if((e===o||!e)&&setTimeout)return e=setTimeout,setTimeout(t,0);try{return e(t,0)}catch(r){try{return e.call(null,t,0)}catch(r){return e.call(this,t,0)}}}!function(){try{e="function"==typeof setTimeout?setTimeout:o}catch(t){e=o}try{r="function"==typeof clearTimeout?clearTimeout:i}catch(t){r=i}}();var a,c=[],l=!1,h=-1;function u(){l&&a&&(l=!1,a.length?c=a.concat(c):h=-1,c.length&&f())}function f(){if(!l){var t=s(u);l=!0;for(var e=c.length;e;){for(a=c,c=[];++h<e;)a&&a[h].run();h=-1,e=c.length}a=null,l=!1,function(t){if(r===clearTimeout)return clearTimeout(t);if((r===i||!r)&&clearTimeout)return r=clearTimeout,clearTimeout(t);try{r(t)}catch(e){try{return r.call(null,t)}catch(e){return r.call(this,t)}}}(t)}}function d(t,e){this.fun=t,this.array=e}function w(){}n.nextTick=function(t){var e=new Array(arguments.length-1);if(arguments.length>1)for(var r=1;r<arguments.length;r++)e[r-1]=arguments[r];c.push(new d(t,e)),1!==c.length||l||s(f)},d.prototype.run=function(){this.fun.apply(null,this.array)},n.title="browser",n.browser=!0,n.env={},n.argv=[],n.version="",n.versions={},n.on=w,n.addListener=w,n.once=w,n.off=w,n.removeListener=w,n.removeAllListeners=w,n.emit=w,n.prependListener=w,n.prependOnceListener=w,n.listeners=function(t){return[]},n.binding=function(t){throw new Error("process.binding is not supported")},n.cwd=function(){return"/"},n.chdir=function(t){throw new Error("process.chdir is not supported")},n.umask=function(){return 0};var g={};(function(t){(function(){g=class{constructor(t={}){if(!t.wallet)throw new Error("Instance of minimal-slp-wallet must be passed in the config object when instantiating.");this.wallet=t.wallet,this.bchjs=t.wallet.bchjs}async getTokenUtxos(t,e,r){try{t=this.bchjs.SLP.Address.toCashAddress(t);const r=(await this.wallet.getUtxos(t)).slpUtxos.type1.tokens;let n;return n=e?r.filter(t=>t.tokenId&&t.tokenId.includes(e)):r.filter(t=>!t.tokenId)}catch(n){throw console.error("Error in merit.js/getTokenUtxos()"),n}}getTokenQuantity(t){try{let e=0;return t.map(t=>{e+=Number(t.tokenQty)}),e}catch(e){throw console.error("Error in merit.js/getTokenQuantity()"),e}}async calcMerit(e,r,n){try{if(!Array.isArray(e))throw new Error("Input hydratedUtxo must be an array");const o=this.bchjs.SLP.Address.toCashAddress(r),i=144,s=await this.bchjs.Blockchain.getBlockCount(),a=[];for(let r=0;r<e.length;r++){const c=e[r];let l=c.height;const h=await this.getParentAge(c.tx_hash,o);h&&(l=h.height);let u,f=(s-l)/i;f=this.bchjs.Util.floor2(f),0===c.height&&(f=0),u=n?Number(c.tokenQty):c.value/1e8,1===t.env.MERIT_AGE&&(u*=f),c.age=f,c.merit=u,a.push(c)}return a}catch(o){throw console.error("Error in merit.js/getMerit()"),o}}async getParentAge(t,e){try{let r=!1;for(;t;){const n=await this.findTokenParent(t,e);t=n.tx_hash,n&&(r=n)}return r}catch(r){throw console.error("Error in merit.js/getParentAge()"),r}}async findTokenParent(t,e){try{let r=!1,n=await this.wallet.getTxData([t]);const o=(n=n[0]).tokenId,i=n.vin.map(t=>({txid:t.txid,vout:t.vout})),s=await this.wallet.getTransactions(e);for(let t=0;t<i.length;t++){const e=i[t].txid,n=s.filter(t=>t.tx_hash===e);if(n.length>0)for(let s=0;s<n.length;s++){const e=n[s],a=await this.wallet.getTxData([e.tx_hash]),c=a[0].tokenId;e.tx_pos=i[t].vout,a[0].isValidSlp&&o===c&&(r=e)}}return r}catch(r){throw console.error("Error in findTokenParent()"),r}}async agMerit(t,e,r){try{if(!t)throw new Error("an address must be specified!");const n=await this.getTokenUtxos(t,e,r),o=await this.calcMerit(n,t,e);let i=0;return o.map(t=>i+=t.merit),i}catch(n){throw console.error("Error in merit.js/agMerit()"),n}}}}).call(this)}).call(this,t);return class{constructor(t={}){if(!t.wallet)throw new Error("minimal-slp-wallet instance must be passed in the config object when instantiating.");this.wallet=t.wallet,this.merit=new g(t)}}}));